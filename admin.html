<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalyna Map Notes - Admin Review</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; padding: 24px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: #0b0f14; color: #e6edf3;
    }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 16px; font-size: 20px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .card {
      background: #0f1620; border: 1px solid #223042; border-radius: 12px;
      padding: 14px; margin-top: 14px;
    }
    input, button, textarea {
      font: inherit;
      border-radius: 10px;
      border: 1px solid #223042;
      background: #0b0f14; color: #e6edf3;
      padding: 10px 12px;
      outline: none;
    }
    input { min-width: 320px; }
    button { cursor: pointer; }
    button:hover { border-color: #3a516e; }
    .btn-ok { border-color: #2f6f3e; }
    .btn-ok:hover { border-color: #45a05b; }
    .btn-bad { border-color: #7a2b2b; }
    .btn-bad:hover { border-color: #b93c3c; }
    .muted { opacity: .75; }
    .mono { font-family: inherit; }
    .note-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .note-meta { opacity: .75; font-size: 12px; margin-bottom: 10px; }
    .note-body { white-space: pre-wrap; line-height: 1.45; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 800px) { .grid2 { grid-template-columns: 1fr; } input { min-width: 220px; } }
    .pill {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      border: 1px solid #223042; font-size: 12px; opacity: .85;
    }
    .danger { border-color: #7a2b2b; color: #ffb4b4; }
    .ok { border-color: #2f6f3e; color: #b8ffd0; }
    .warn { border-color: #7a6a2b; color: #ffe7a8; }
    .topbar { display:flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items:center; }
    .statusline { margin-top: 10px; font-size: 12px; opacity: .8; }
    a { color: #9ecbff; }
    code { background: #0b0f14; border: 1px solid #223042; border-radius: 8px; padding: 2px 6px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Map Notes ç®¡ç†å‘˜å®¡æ ¸</h1>
      <div class="muted">æ¥å£ï¼š<code id="apiShow"></code></div>
    </div>

    <div class="card">
      <div class="row">
        <label class="muted">ADMIN_TOKENï¼š</label>
        <input id="token" placeholder="ç²˜è´´ä½ çš„ ADMIN_TOKEN" />
        <button id="save">ä¿å­˜</button>
        <button id="clear" class="btn-bad">æ¸…é™¤</button>
      </div>
      <div class="statusline" id="tokenStatus"></div>
    </div>

    <div class="card">
      <div class="row">
        <button id="reloadPending" class="btn-ok">æ‹‰å– Pending åˆ—è¡¨</button>
        <button id="reloadApproved">æ‹‰å– Approved åˆ—è¡¨</button>
        <button id="reloadAuto">æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°ï¼šå…³</button>
        <span class="muted">å½“å‰ï¼š<b id="mode">pending</b>ï½œå…± <b id="count">0</b> æ¡</span>
      </div>
      <div class="statusline" id="status"></div>
    </div>

    <div id="list"></div>
  </div>

<script>
/**
 * âœ… ä½ åªéœ€è¦æ”¹è¿™é‡Œï¼šæŠŠå®ƒæ¢æˆä½ çš„ Worker åŸŸå
 * ä¾‹å¦‚ï¼šhttps://map-api.20060303jjc.workers.dev
 */
const MAP_NOTES_API = "https://map-api.20060303jjc.workers.dev";

const LS_KEY = "KALYNA_ADMIN_TOKEN_V1";

const elApiShow = document.getElementById("apiShow");
const elToken = document.getElementById("token");
const elTokenStatus = document.getElementById("tokenStatus");
const elStatus = document.getElementById("status");
const elList = document.getElementById("list");
const elCount = document.getElementById("count");
const btnSave = document.getElementById("save");
const btnClear = document.getElementById("clear");
const btnReloadPending = document.getElementById("reloadPending");
const btnReloadApproved = document.getElementById("reloadApproved");
const btnReloadAuto = document.getElementById("reloadAuto");
const elMode = document.getElementById("mode");

let currentMode = "pending"; // pending | approved

elApiShow.textContent = MAP_NOTES_API;

function getToken() {
  return localStorage.getItem(LS_KEY) || "";
}
function setToken(v) {
  localStorage.setItem(LS_KEY, v);
}
function clearToken() {
  localStorage.removeItem(LS_KEY);
}

function fmtTime(ms) {
  const d = new Date(Number(ms));
  if (isNaN(d.getTime())) return String(ms);
  return d.toLocaleString();
}

function setStatus(msg) { elStatus.textContent = msg; }
function setTokenHint() {
  const t = getToken();
  elToken.value = t;
  elTokenStatus.innerHTML = t
    ? `<span class="pill ok">å·²ä¿å­˜</span> token å·²å†™å…¥ localStorageï¼ˆåªåœ¨ä½ çš„æµè§ˆå™¨é‡Œï¼‰`
    : `<span class="pill warn">æœªè®¾ç½®</span> è¯·è¾“å…¥ token æ‰èƒ½å®¡æ ¸`;
}

async function apiGetPending() {
  const token = getToken();
  if (!token) throw new Error("missing token");

  const res = await fetch(`${MAP_NOTES_API}/api/admin/pending`, {
    method: "GET",
    headers: { "X-Admin-Token": token },
    cache: "no-store",
  });

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`pending failed: ${res.status} ${text}`);
  }
  return res.json();
}

async function apiGetApproved() {
  const token = getToken();
  if (!token) throw new Error("missing token");

  const res = await fetch(`${MAP_NOTES_API}/api/admin/approved`, {
    method: "GET",
    headers: { "X-Admin-Token": token },
    cache: "no-store",
  });

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`approved failed: ${res.status} ${text}`);
  }
  return res.json();
}

async function apiApprove(id) {
  const token = getToken();
  const res = await fetch(`${MAP_NOTES_API}/api/admin/approve`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Token": token
    },
    body: JSON.stringify({ id })
  });
  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`approve failed: ${res.status} ${text}`);
  }
  return res.json();
}

async function apiDelete(id) {
  const token = getToken();
  const res = await fetch(`${MAP_NOTES_API}/api/admin/delete`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Token": token
    },
    body: JSON.stringify({ id })
  });
  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`delete failed: ${res.status} ${text}`);
  }
  return res.json();
}

function renderNote(n) {
  const isApproved = (n.status === "approved") || (currentMode === "approved");

  const link = (n.link_url && n.link_text)
    ? `<div class="muted" style="margin-top:8px">ğŸ”— <a href="${escapeHtml(n.link_url)}" target="_blank" rel="noopener">${escapeHtml(n.link_text)}</a></div>`
    : (n.link_url ? `<div class="muted" style="margin-top:8px">ğŸ”— <a href="${escapeHtml(n.link_url)}" target="_blank" rel="noopener">${escapeHtml(n.link_url)}</a></div>` : "");

  const body = n.body ? `<div class="note-body">${escapeHtml(n.body)}</div>` : `<div class="muted">ï¼ˆæ— æ­£æ–‡ï¼‰</div>`;

  const pill = isApproved
    ? `<span class="pill ok">approved</span>`
    : `<span class="pill warn">pending</span>`;

  // pendingï¼šApprove + Delete
  // approvedï¼šåªæ˜¾ç¤º Deleteï¼ˆä½ è¦çš„â€œå¯ä»¥åˆ å·²å­˜åœ¨ notesâ€ï¼‰
  const actionsHTML = isApproved
    ? `<button class="btn-bad" data-action="delete">âŒ Delete</button>`
    : `
      <button class="btn-ok" data-action="approve">âœ… Approve</button>
      <button class="btn-bad" data-action="delete">âŒ Delete</button>
    `;

  const hintText = isApproved
    ? "Delete = ç›´æ¥åˆ é™¤ï¼ˆä¼šä»å…¬å¼€åœ°å›¾æ¶ˆå¤±ï¼‰"
    : "Approve = å˜æˆ approved å¹¶å…¬å¼€æ˜¾ç¤ºï¼›Delete = ç›´æ¥åˆ é™¤";

  const html = `
    <div class="card" data-id="${n.id}">
      <div class="grid2">
        <div>
          <div class="note-title">${escapeHtml(n.title || "(no title)")}</div>
          <div class="note-meta">
            ${pill}
            <span class="muted">id:</span> <code>${escapeHtml(n.id)}</code><br>
            <span class="muted">åæ ‡:</span> ${Number(n.lat).toFixed(6)}, ${Number(n.lng).toFixed(6)}<br>
            <span class="muted">æäº¤æ—¶é—´:</span> ${escapeHtml(fmtTime(n.created_at))}
          </div>
          ${body}
          ${link}
        </div>

        <div>
          <div class="row" style="justify-content:flex-end">
            ${actionsHTML}
          </div>
          <div class="statusline muted" style="text-align:right;margin-top:10px">
            ${hintText}
          </div>
        </div>
      </div>
    </div>
  `;
  return html;
}

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function updateAutoButtonText(){
  if (!autoTimer) btnReloadAuto.textContent = "æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°ï¼šå…³";
  else btnReloadAuto.textContent = `æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°ï¼ˆ${currentMode}ï¼‰ï¼šå¼€`;
}

async function reload() {
  elMode.textContent = currentMode;
  setStatus(`æ­£åœ¨æ‹‰å– ${currentMode}...`);
  elList.innerHTML = "";
  elCount.textContent = "0";

  try {
    const list = (currentMode === "approved")
      ? await apiGetApproved()
      : await apiGetPending();

    elCount.textContent = String(list.length);

    if (!list.length) {
      elList.innerHTML = `<div class="card muted">æ²¡æœ‰ ${escapeHtml(currentMode)}ã€‚</div>`;
      setStatus("å®Œæˆã€‚");
      return;
    }

    elList.innerHTML = list.map(renderNote).join("");
    setStatus(`å®Œæˆï¼š${list.length} æ¡ ${currentMode}ã€‚`);
  } catch (e) {
    setStatus(`é”™è¯¯ï¼š${e.message}`);
    elList.innerHTML = `<div class="card"><span class="pill danger">ERROR</span> <span class="muted">${escapeHtml(e.message)}</span></div>`;
  }
}

elList.addEventListener("click", async (ev) => {
  const btn = ev.target.closest("button");
  if (!btn) return;

  const card = ev.target.closest("[data-id]");
  if (!card) return;

  const id = card.getAttribute("data-id");
  const action = btn.getAttribute("data-action");
  if (!id || !action) return;

  btn.disabled = true;

  try {
    if (action === "approve") {
      setStatus(`æ­£åœ¨ approveï¼š${id}`);
      await apiApprove(id);
      card.remove();
      elCount.textContent = String(Math.max(0, Number(elCount.textContent) - 1));
      setStatus("approve æˆåŠŸã€‚");
    } else if (action === "delete") {
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ")) { btn.disabled = false; return; }
      setStatus(`æ­£åœ¨ deleteï¼š${id}`);
      await apiDelete(id);
      card.remove();
      elCount.textContent = String(Math.max(0, Number(elCount.textContent) - 1));
      setStatus("delete æˆåŠŸã€‚");
    }
  } catch (e) {
    alert(e.message);
    setStatus(`æ“ä½œå¤±è´¥ï¼š${e.message}`);
  } finally {
    btn.disabled = false;
  }
});

btnSave.addEventListener("click", () => {
  const v = elToken.value.trim();
  if (!v) { alert("token ä¸èƒ½ä¸ºç©º"); return; }
  setToken(v);
  setTokenHint();
});

btnClear.addEventListener("click", () => {
  clearToken();
  setTokenHint();
});

btnReloadPending.addEventListener("click", () => {
  currentMode = "pending";
  updateAutoButtonText();
  reload();
});

btnReloadApproved.addEventListener("click", () => {
  currentMode = "approved";
  updateAutoButtonText();
  reload();
});

let autoTimer = null;
btnReloadAuto.addEventListener("click", () => {
  if (autoTimer) {
    clearInterval(autoTimer);
    autoTimer = null;
    btnReloadAuto.textContent = "æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°ï¼šå…³";
  } else {
    autoTimer = setInterval(reload, 10000);
    btnReloadAuto.textContent = `æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°ï¼ˆ${currentMode}ï¼‰ï¼šå¼€`;
    reload();
  }
});

// init
setTokenHint();
reload();
</script>
</body>
</html>
